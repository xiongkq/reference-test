# Mai协议v3

_刘杰 MCDEX创始人_

## 1. 简介

Mai Protocol v3是MCDEX推出的一种基于自动做市商（AMM）的去中心化永续合约协议。永续合约是一种价格锚定底层资产的价格指数、没有到期日且支持保证金交易的金融合约。

协议的名字来源于中文的"买"和"卖"的拼音.

本协议的目标是使得任何人都可以在区块链上无需许可的创建、交易DeFi永续合约。首先，任何人只需要提供底层资产的价格指数（index price）就可以通过本协议在链上创建永续合约。永续合约可以使用任何ERC20代币作为抵押物。再者，本协议为永续合约专门设计了一种高资金效率的AMM。我们希望通过AMM解决永续合约的流动性问题。任何人都可以给通过向AMM存入抵押物的方式给AMM添加流动性并获得可观的做市收益。最后，任何人都可以无需许可的交易永续合约。交易员的保证金以非托管的方式质押在智能合约内。交易过程也完全在链上智能合约里完成。

协议的智能合约经过了严格的第三方审计，协议也没有管理员密钥（Admin key），从而最大化的保证了协议的安全性与去中心化特性。

我们认为无需许可是本协议成功的最大关键。由于这一特性本协议可以赋能整个社区共同建设MCDEX生态。任何人都可以方便的、低成本的创建并运维各种链上、链下资产的衍生品。我们相信，在MCDEX社区的共同建设下，MCDEX上的永续合约资产会极大丰富，交易量也会不断上升。

## 2. 基于AMM的市场结构

本协议完全使用AMM进行交易。关于AMM的详细技术设计，请参考《MAI v3 AMM设计文档》。

本协议的市场结构可以简单理解为于永续合约版的Uniswap。市场中有如下角色：

### AMM:

每个永续合约都有一个独立的自动做市商。自动做市商充当中心化对手方的角色，为永续合约提供持续的流动性。像一个正常的交易员，AMM也有独立的保证金账户，AMM的也可能会有持仓头寸。

### Operator:

Operator是永续合约的创建者和运营者。

* 如何成为一个Operator: 
  * 创建永续合约，设置永续合约的初始参数（例如保证金率、AMM风险参数等等）。永续合约的AMM有一组风险参数。通过调整这些参数，可以改变AMM的做市风险、交易深度、滑点、盘口价差等等。
  * 为合约购买（或直接提供）Oracle服务。本协议定义了一种Oracle接口，现有的各种Oracle服务可以很容易的对接到本协议。另一方面，Operator也可以自己为永续合约提供Oracle数据。
  * 协议允许Operator在创建永续合约时为每个风险参数设置一个有效范围。Operator可以根据市场情况在在这个范围内动态调整风险参数的设置。
  * 当Operator希望调整参数范围时，可以发起治理提案。（见2.10 AMM参数与治理）
  * Operator可以转移自己身份给其他地址，也可以销毁Operator角色。没有Operator的永续合约将完全由LP治理。
* Operator 收益：
  * Operator可以设置一定比例的运营手续费，从而从每笔交易中获利。
  * MCDEX也会向一些AMM的Operator提供MCB流动激励。（见3 MCB tokenomics）
  * 参与AMM的治理
* Operator的风险：无

Operator每十天必须签到一次，逾期不签到将被开除。

### Liquidity Provider:

AMM的流动性提供者

* 如何成为LP：
  * LP向AMM的资金池存入资金
* LP的收益：
  * 固定比例的交易手续费
  * 买卖价差\(spread\)及滑点\(slippage\)带来的收益\(profile\)
  * 交易员支付的资金费用
  * 强制平仓罚金
  * MCDEX会向一些AMM的LP提供MCB流动激励（见3 MCB 经济模型）。
  * LP可以参与AMM的治理（见2.10 AMM参数与治理）
* LP的风险：
  * 当AMM具有头寸时，AMM具有风险暴露，如果此时指数价格变化，可能造成持仓亏损。这部分亏损会被所有LP分担。

当AMM具有头寸时，AMM自动通过以下三种方式降低LP的风险：

* 向对手方征收资金费用
* 增加AMM报价的买一与卖一之间的点差
* 调整报价，抑制交易员进一步增加AMM的持仓，鼓励交易员减少AMM的持仓；例如，当AMM持有多头时，AMM给出的卖价和买价都将降低，但买价降低的幅度大于卖价。

### Trader：

交易员是市场中最主要的参与方。交易员通过与AMM交易开仓、平仓，实现盈亏。交易员总是吃单方（Taker）。在本协议中，交易员无法绕过AMM相互成交，所有的交易必须通过AMM达成。交易员在交易过程中，需要向AMM支付交易手续。交易员根据资金费率规则支付\(或接受\)资金费用。

### Keeper：

Keeper是一类辅助角色。任何人都可以成为Keeper对保证金不足账户进行强制平仓。（见2.4强制平仓）

### Delegator：

代理是一类特殊的角色。每个保证金账户都可以设置自己的代理人。代理人可以操作账户进行交易（包括直接与AMM交易及通过Broker交易）。但代理人无法从账户中取出资金。通过代理人功能，可以实现冷热钱包分离及交易策略托管等功能。

## 3. 资金费用

和传统的永续合约类似，资金费用是使得本协议的永续合约价格锚定指数的重要手段。

本协议的AMM设计中，由于交易都必须经过AMM达成，所以如果AMM没有头寸时，可以认为市场的多空需求是平衡的。此时AMM会给出一个在指数（Index）附近的买入\(bid\)/卖出\(ask\)报价，即可以认为此时市场价是锚定指数的价格。

当AMM持有某个方向的头寸时，AMM给出的报价也会向相应方向偏移。当AMM持多头时，AMM报价会向低于index的方向偏移，反之AMM报价会向高于index的方向偏移。此时，可以认为市场的多空需求不平衡，市场价格也相对指数发生的偏移。这种情况下，协议会向与AMM持仓相反的头寸征收资金费用支付给与AMM持仓相同的头寸（包括AMM）。资金费率与AMM持仓量正相关。即AMM持有的头寸越多，市场价偏离约严重，此时也会收取更高的资金费用。

当出现资金费用时，一方面可以阻止更多交易员成为AMM的对手方，防止价格进一步的偏离。另一方面，高资金费率也会吸引更多的LP添加流动性或进入与AMM相同的头寸，赚取资金费用。根据AMM的设计，向AMM添加流动性或与AMM交易减少AMM的持仓都会减少价格偏离的程度。上述两方面的作用，会使得市场价格回归指数。

## 4. 保证金与盈亏

由于本协议的无需许可的特点，任何人都可以创建风险程度各不相同的永续合约。为了防止风险在不同的永续合约之间随意传递，本协议使用隔离保证金机制（Isolated Margin）。在隔离保证金机制下，交易员每个永续合约内都有一个独立的保证金账户，该保证金账户的盈亏不会影响其他合约的保证金账户。

当交易员以 `P_entry`, 的价格做多或做空 `ΔN` 个合约时，`ΔN>0` 意味着该交易员做多，而`ΔN<0`意味着该交易员做空。

当开仓时，保证金账户的余额须不小于初始保证金：

```text
  P_mark·|N|·R_im
```

P\_mark是Oracle提供的标价。`P_mark` 通常等于指数价格`P_index`，或者是指数价格`P_index`的时间加权平均价格（当使用以Uniswap为例的去中心化预言机时）。 `R_im`是永续合约的初始保证金率。

头寸盈亏的计算如下：

```text
  (P_mark-P_entry)·ΔN
```

用户可以在任何时间提取MCDEX 永续仓位的盈利。也就是说，此合约中的“PNL”永远指的是已实现的盈亏。并且持仓亏损也是由实时的保证金账户余额推演而来的。

交易员可以平仓价格/止损价格P\_exit平仓，其平仓后PNL为：

```text
  (P_exit-P_entry)·N
```

交易员务必确保保证金账户余额不小于维持保证金M\_mm：

```text
  P_mark·|N|·R_mm
```

如果保证金账户余额无法达到维持保证金的数额，则该仓位将会被强平。

最后，每个永续合约都有一个” Keeper Gas Reward”参数。当头寸被强制平仓时，Keeper可以获得该参数规定的奖励用于支付Gas。所以，本协议要求，只要保证金账户的头寸不为0（无论头寸的价值如何），保证金账户至少要有可以支付“Keeper Gas Reward”的保证金余额，否则头寸也会被强制平仓。

## 5. 强制平仓

当保证金账户内的保证金余额低于头寸的维持保证金时，头寸将被强制平仓。任何人都可以作为Keeper对保证金不足的头寸发起强制平仓。Keeper可以选择两种强制平仓方式之一：

* 通过AMM强制平仓：被强制平仓的头寸将通过AMM平仓。这也意味着头寸被转移给了AMM。强制平仓罚金将进入AMM的资金池。Keeper可以获得“Keeper Gas Reward”数量的资金作为清算奖励。
* 由Keeper强制平仓：被强制平仓的头寸将被转移给Keeper。这种模式下，Keeper承担了头寸风险，也将获得强制平仓罚金。

## 6. 交割

虽然是永续合约，但是在遇到极端行情下，依旧会出现流动性匮乏情况。如果在强制平仓时由于AMM的流动性不足或者清算不及时出现清算损失（Liquidation Loss）时，AMM中的保险基金会首先用于支付清算损失。如果AMM的保险基金也不足以偿付损失时，合约会进入交割状态。永续合约会以最后的指数价格进行交割。合约中剩余的资产会按持有头寸的交易员的保证金余额的比例进行分配。也就是说，清算损失是由所有的持有头寸的交易员根据其保证金余额规模共同承担的。这也意味着，如果交易员没有头寸，则不会承担任何清算损失。我们认为，在极端行情下尽快交割合约并使得交易员可以提取出自己的保证金可以保护各方利益，也是一种变相的市场熔断机制。交易员可以在市场情绪稳定后，重新创建永续合约继续交易。

另外，当Oracle超过24小时不更新数据时，合约也会进入交割状态。

合约的交割分为两个阶段，第一阶段称之为紧急状态（Emergency），在这一状态时，永续合约Oracle不再更新。此时，Keeper对永续合约的所有保证金账户发起复查操作。Keeper将获得等于“Keeper Gas Reward”的奖励。在复查操作中，会以交割价计算保证金账户的保证金余额。 当所有的保证金账户复查完毕，交割进入第二阶段称之为清算完成状态（Cleared）。在此阶段，交易员可以提取出剩余的保证金。

## 7. 保险基金

每个永续合约都附带1个保险基金用于赔付系统的清算损失。

任何人都可以向保险基金内捐献资金。我们鼓励Operator向一级保险基金中捐献初始资金，并在合约持续运营的过程中补充持续资金。

当账户的维持保证金不足而被清算时，将收取一定的清算罚金。清算罚金中一定比例（由AMM参数确定）的资金归属保险基金，剩余罚金归属清算人（AMM或Keeper）。 每个保险基金设置一个基金规模上限。当保险基金达到上限时，新增的资金会进入AMM的流动性资金池。LP可以通过治理的方式调大保险基金的规模上限，但不能下调。

## 8. 限价与止损单

直接与AMM进行交易类似通过传统订单簿的市价单交易。在永续合约交易场景下，人们往往喜欢通过限价单等待交易机会、控制成交价格。另外，止损单也是一类高杠杆交易时重要的工具。为此，我们提供了相对中心化的限价单和止损单功能。交易员可以签名一个限价单或止损单，并把订单发送到其信任的“Broker“服务器。Broker服务器不断观察链上AMM的报价，并在AMM报价符合交易员订单需求的情况下，向链上智能合约提交订单。链上智能合约收到Broker提交的订单后，会首先验证订单的有效，并随后按照订单内容执行订单。

值得注意的是，Broker不会对收到的订单进行撮合，所有的订单按先入先出的顺序与AMM成交。由于Broker代替交易员支付了上线的Gas费，Broker可以向交易员收取一部分费用。

## 9. 安全性

我们深知安全性是这类协议最重要的关键。在本协议发布时，所有的智能合约及后续升级都必须经过严格的安全审计才能上线。AMM的金融结构设计也经过了同行评审。

为了最大化本协议的去中心化特性，协议代码中没有任何管理员密钥（Admin Key）。

另一方面，任何人都可以无需许可的创建永续合约。虽然Operator只被授予了有限的权限，在一定程度上提高了永续合约的安全性，但交易员需要仔细甄别选择交易的永续合约，并承担相应的风险。我们鼓励Operator选择去中心化的Oracle服务，并将风险参数的范围设置在尽量小的区间内（甚至让参数不可改），从而最小化交易员的信任成本。

智能合约已由quantstamp审计：[MCDEX Audit Report](https://certificate.quantstamp.com/full/mcdex)。

## 10. 推荐（referral）

本协议支持给于推荐人一定的推荐佣金。交易时（直接与AMM交易或者通过Broker下订单）可以指定一个推荐人。推荐人可以从这笔交易的Operator手续费与LP手续费中获得一定比例的佣金。返佣比例由AMM的治理确定。通过这种方式，有用户资源的机构可以运营自己的前端UI，并通过向AMM导入交易员的方式获取收益。

## 11. AMM的参数及治理

AMM的参数分为可修改参数和不可修改参数。Operator与LP可以通过投票的方式调整可修改参数。AMM有5个风险参数，每个风险参数都有一个有效范围。Operator可以根据市场情况在有效范围内自由调节风险参数。如果需要修改风险参数的有效范围，则需要通过AMM内的投票治理。

Operator可以发起治理提案。如果永续合约没有Operator，也可以由不低于1%份额的LP发起治理提案。每个治理提案需要由LP投票通过后执行。投票率（Vote Quorum）不得低于LP总份额的10%。只有在提案发起前存在的LP代币具有投票权。每个提案的投票时间为72小时，决议通过后需要经过48小时的时间锁后方能生效。LP在投票时需要质押LP代币。如果提案通过，投赞成票的LP代币将在提案执行后72小时解锁，投反对票的LP代币将在投票结束立刻解锁；如果提案没有通过，则参与投票的所有LP代币将在投票结束后立刻解锁。LP发起提案时，该LP自动质押LP代币并投赞成票。

| AMM参数 | 含义 | 可修改/不可修改 |
| :--- | :--- | :--- |
| 底层资产 | 一个标识合约底层资产的字符串 | 不可修改 |
| 抵押物代币地址 | 抵押物ERC20代币地址 | 不可修改 |
| Operator地址 | Operator的地址 | Operator可以修改 |
| Oracle 适配器地址 | 兼容Mai3 Oracle 标准的适配器合约地址 | 不可修改 |
| 初始保证金率 | 初始保证金率，决定了开仓的最大杠杆 | LP治理修改，只能减小 |
| 维持保证金率 | 维持保证金率，决定了头寸被强制平仓时的杠杆；必须小于初始保证金 | LP治理修改，只能减少 |
| 金库费率 | 交易手续费中进入DAO金库的费率 | 由MCDEX DAO治理修改 |
| Operator费率 | 交易手续费中归属Operator的费率，不大于1% | LP治理修改 |
| LP 费率 | 交易手续费中归属LP的费率，不大于1% | LP治理修改 |
| 推荐返点Referral Rebate费率 | 从Operator和LP费中给予Referral的返点比例 | LP治理修改 |
| 强平罚金费率 | 强制平仓罚金费率。罚金=头寸价值\*罚金费率。不大于维持保证金率。 | LP治理修改 |
| 保险基金费率 | 罚金中归属保险基金的比例 | LP治理修改 |
| 保险基金最大值 | 保险基金规模上限 | LP治理修改，只能增大 |
| Keeper Gas Reward | 当Keeper执行强制平仓或在交割阶段复查账户时，获得的固定数量的奖励，用于支付Keeper的Gas费用。 | LP治理修改 |
| AMM做市风险参数 | 一组控制AMM做市商风险的参数 | 通过治理修改参数有效范围, Operator可在范围内整 |

值得注意的是，每个AMM都有一组做市商风险参数，这些参数决定了AMM的以下做市特征：盘口价差（Spread）、滑点（Slippage）、AMM最大持仓规模、AMM持仓量与资金费率的关系。每个风险参数都有一个有效范围。Operator可以不经过治理流程直接在有效范围内修改风险参数。通过这种方式，LP可以授权Operator根据市场情况及时调整风险参数，这在永续合约上线运营初期是很有必要的。当合约运营一段时间、风险参数趋于稳定后，LP可以通过治理减少风险参数的有效范围（甚至固定风险参数），从而提高AMM的去中心化程度。

除了修改AMM的参数的提案外，还有3个特殊的提案，通过这些提案需要的投票率不得低于LP总份额的20%：

* 升级AMM的智能合约代码，这使得AMM具有了升级的能力；
* 使永续合约进入交割状态；
* 设置新的Operator。只有当合约没有Operator时，LP可以发起提案设置新的Operator；

## 12. 多链部署

我们认为不同的公链都有各自的用户和生态。本协议在公链的选择上是中立的。为了最大化本协议的使用场景，本协议的智能合约可以被部署到各种公链上。MCDEX DAO将作为主体支持本协议在各个公链上的发展，推动MCDEX生态不断扩张壮大。

